

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ISCSI Remote Storage &mdash; Sipa Linux Admin Class latest documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Sipa Linux Admin Class latest documentation" href="index.html"/>
        <link rel="next" title="Network Virtualization Device" href="virtualdev.html"/>
        <link rel="prev" title="Linux LVM partition" href="lvm.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Sipa Linux Admin Class
          

          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="systemd.html">Understand systemd</a></li>
<li class="toctree-l1"><a class="reference internal" href="journal.html">Journalclt</a></li>
<li class="toctree-l1"><a class="reference internal" href="configip.html">Configure IP address</a></li>
<li class="toctree-l1"><a class="reference internal" href="firewall.html">Understand New Linux Firewall</a></li>
<li class="toctree-l1"><a class="reference internal" href="sshd.html">SSH Server On CentOS7</a></li>
<li class="toctree-l1"><a class="reference internal" href="setupvm.html">SetupVM for Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="vagrant.html">Build Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="bridgekvm.html">Bridge Networking KVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="ovs.html">OpenVswitch Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="team.html">Network Teaming &amp; Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="lvm.html">Linux LVM partition</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">ISCSI Remote Storage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#iscsi">ISCSI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#disk-management">Disk Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step-1-prepare">step 1 Prepare</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-prepare">step 2 Prepare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#install-iscsi-server">Install ISCSI server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#install">Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#install-iscsi-client">Install ISCSI Client</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#verify">verify</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-disk">use disk</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="virtualdev.html">Network Virtualization Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="packstack.html">Openstack with Packstack</a></li>
<li class="toctree-l1"><a class="reference internal" href="openstack-intro.html">Openstack intro Mitaka Document</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Lab Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="keystone.html">Install keystone</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Sipa Linux Admin Class</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>ISCSI Remote Storage</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/iscsi.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="iscsi-remote-storage">
<h1>ISCSI Remote Storage<a class="headerlink" href="#iscsi-remote-storage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="iscsi">
<h2>ISCSI<a class="headerlink" href="#iscsi" title="Permalink to this headline">¶</a></h2>
<div class="section" id="disk-management">
<h3>Disk Management<a class="headerlink" href="#disk-management" title="Permalink to this headline">¶</a></h3>
<p>การทำสอบให้ใช้ Vagrantfile</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">ssh</span> <span class="n">server1</span>
<span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span>
</pre></div>
</div>
<div class="section" id="step-1-prepare">
<h4>step 1 Prepare<a class="headerlink" href="#step-1-prepare" title="Permalink to this headline">¶</a></h4>
<p>แบ่ง partition ให้แก่ disk /dev/vdb  /dev/vdc  /dev/vdd</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="n">fdisk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb</span>
<span class="n">Press</span> <span class="s1">&#39;p&#39;</span> <span class="n">to</span> <span class="nb">print</span> <span class="n">partition</span> <span class="n">table</span>

<span class="n">Press</span> <span class="s1">&#39;n&#39;</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">partition</span>

<span class="n">Press</span> <span class="s1">&#39;p&#39;</span> <span class="n">to</span> <span class="n">create</span> <span class="n">primary</span> <span class="n">partition</span>

<span class="n">Type</span> <span class="n">Partition</span> <span class="n">Number</span> <span class="p">:</span> <span class="mi">1</span>

<span class="n">First</span> <span class="n">Sector</span>        <span class="p">:</span> <span class="n">PRESS</span> <span class="n">ENTER</span>

<span class="n">Last</span> <span class="n">Sector</span>        <span class="p">:</span>  <span class="n">PRESS</span> <span class="n">ENTER</span>

<span class="n">Press</span> <span class="s1">&#39;p&#39;</span> <span class="n">to</span> <span class="nb">print</span> <span class="n">partition</span> <span class="n">tables</span> <span class="n">again</span>

<span class="n">Press</span> <span class="s1">&#39;t&#39;</span> <span class="n">to</span> <span class="n">change</span> <span class="n">partition</span> <span class="n">ID</span>

<span class="n">Type</span> <span class="n">your</span> <span class="n">partition</span> <span class="n">Number</span> <span class="p">:</span><span class="mi">1</span>

<span class="n">Hex</span> <span class="n">code</span> <span class="n">Partition</span> <span class="n">code</span>     <span class="p">:</span> <span class="mi">8</span><span class="n">e</span>

 <span class="n">Press</span> <span class="s1">&#39;p&#39;</span> <span class="n">to</span> <span class="nb">print</span> <span class="n">partition</span> <span class="n">tables</span> <span class="n">again</span>

<span class="n">Press</span> <span class="s1">&#39;w&#39;</span> <span class="n">to</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ทำซ้ำ กับ <code class="docutils literal"><span class="pre">/dev/vdc</span></code>  <code class="docutils literal"><span class="pre">/dev/vdd</span></code>  หลังจากทำเสร็จแล้วให้สั่งคำสั่ง <code class="docutils literal"><span class="pre">partprobe</span></code> เพื่อบอกให้ kernel รับทราบการเปลี่ยนแปลงของ partition:</p>
<p class="last">partprobe</p>
</div>
</div>
<div class="section" id="step-2-prepare">
<h4>step 2 Prepare<a class="headerlink" href="#step-2-prepare" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="n">pvcreate</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb1</span>
    <span class="n">pvcreate</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdc1</span>
    <span class="n">pvcreate</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdd1</span>

    <span class="n">vgcreate</span> <span class="n">iscsi_vg</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdb1</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdc1</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vdd1</span>
    <span class="n">lvcreate</span> <span class="o">-</span><span class="n">l</span> <span class="mi">100</span><span class="o">%</span><span class="n">FREE</span> <span class="o">-</span><span class="n">n</span> <span class="n">iscsi_lv</span>  <span class="n">iscsi_vg</span>

<span class="n">vgs</span>
<span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">VG</span>         <span class="c1">#PV #LV #SN Attr   VSize  VFree</span>
    <span class="n">VolGroup00</span>   <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">0</span> <span class="n">wz</span><span class="o">--</span><span class="n">n</span><span class="o">-</span> <span class="mf">39.50</span><span class="n">g</span> <span class="mf">320.00</span><span class="n">m</span>
    <span class="n">iscsi_vg</span>     <span class="mi">3</span>   <span class="mi">1</span>   <span class="mi">0</span> <span class="n">wz</span><span class="o">--</span><span class="n">n</span><span class="o">-</span> <span class="mf">59.99</span><span class="n">g</span>      <span class="mi">0</span>

<span class="n">lvs</span>
<span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">LV</span>       <span class="n">VG</span>         <span class="n">Attr</span>       <span class="n">LSize</span>  <span class="n">Pool</span> <span class="n">Origin</span> <span class="n">Data</span><span class="o">%</span>  <span class="n">Meta</span><span class="o">%</span>  <span class="n">Move</span> <span class="n">Log</span> <span class="n">Cpy</span><span class="o">%</span><span class="n">Sync</span> <span class="n">Convert</span>
    <span class="n">LogVol00</span> <span class="n">VolGroup00</span> <span class="o">-</span><span class="n">wi</span><span class="o">-</span><span class="n">ao</span><span class="o">----</span> <span class="mf">37.69</span><span class="n">g</span>
    <span class="n">LogVol01</span> <span class="n">VolGroup00</span> <span class="o">-</span><span class="n">wi</span><span class="o">-</span><span class="n">ao</span><span class="o">----</span>  <span class="mf">1.50</span><span class="n">g</span>
    <span class="n">iscsi_lv</span> <span class="n">iscsi_vg</span>   <span class="o">-</span><span class="n">wi</span><span class="o">-</span><span class="n">a</span><span class="o">-----</span> <span class="mf">59.99</span><span class="n">g</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="install-iscsi-server">
<h3>Install ISCSI server<a class="headerlink" href="#install-iscsi-server" title="Permalink to this headline">¶</a></h3>
<div class="section" id="install">
<h4>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h4>
<p>การใช้งานจะมี 2 ฝั่ง คือ server เป็นผู้ให้บริการ storage และ ฝั่ง client โดยที่ฝั่ง server ดำเนินการดังต่อไปนี้</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">targetcli</span>
<span class="n">targetcli</span>
<span class="ne">Warning</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">load</span> <span class="n">preferences</span> <span class="n">file</span> <span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">targetcli</span><span class="o">/</span><span class="n">prefs</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span>
<span class="n">targetcli</span> <span class="n">shell</span> <span class="n">version</span> <span class="mf">2.1</span><span class="o">.</span><span class="n">fb41</span>
<span class="n">Copyright</span> <span class="mi">2011</span><span class="o">-</span><span class="mi">2013</span> <span class="n">by</span> <span class="n">Datera</span><span class="p">,</span> <span class="n">Inc</span> <span class="ow">and</span> <span class="n">others</span><span class="o">.</span>
<span class="n">For</span> <span class="n">help</span> <span class="n">on</span> <span class="n">commands</span><span class="p">,</span> <span class="nb">type</span> <span class="s1">&#39;help&#39;</span><span class="o">.</span>

<span class="o">/&gt;</span>
<span class="p">(</span><span class="n">หลังจาก</span> <span class="n">run</span> <span class="n">คำสั่งแล้วจะได้</span> <span class="n">prompt</span> <span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>step1 create backstores  (target)</li>
</ul>
<p>method1 แบบทีละขั้นตอน</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/&gt;</span><span class="n">ls</span>
<span class="o">/&gt;</span><span class="n">cd</span> <span class="n">backstores</span>
<span class="o">/&gt;</span><span class="n">ls</span>
<span class="o">/&gt;</span><span class="n">cd</span> <span class="n">block</span>
<span class="o">/&gt;</span><span class="n">create</span> <span class="n">server1</span><span class="o">.</span><span class="n">disk1</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">iscsi_vg</span><span class="o">/</span><span class="n">iscsi_lv</span>
<span class="o">/&gt;</span><span class="n">ls</span>
</pre></div>
</div>
<img alt="_images/iscsi001.png" src="_images/iscsi001.png" />
<p>method2 แบบขั้นตอนเดียว</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/&gt;</span> <span class="n">ls</span>
<span class="o">/&gt;</span> <span class="n">backstores</span><span class="o">/</span><span class="n">block</span> <span class="n">create</span> <span class="n">server1</span><span class="o">.</span><span class="n">disk1</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">iscsi_vg</span><span class="o">/</span><span class="n">iscsi_lv</span>
</pre></div>
</div>
<img alt="_images/iscsi002.png" src="_images/iscsi002.png" />
<p>นอกจากการสร้าง backstore ให้สามารถใช้งาน disk แล้ว ยังสามารถสร้าง backstore จาก file system เป็นชนิด fileio เช่นสร้าง fileio มีชื่อว่า sharedata มีขนาด 1G ไว้ที่ /opt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/&gt;</span> <span class="n">backstores</span><span class="o">/</span><span class="n">fileio</span> <span class="n">create</span> <span class="n">sharedata</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">sharedata</span><span class="o">.</span><span class="n">img</span> <span class="mi">1</span><span class="n">G</span>
</pre></div>
</div>
<ul class="simple">
<li>step2 สร้าง iSCSI qualified name (IQN) ชื่อ iqn.2016-07.com.example.server1 ตามด้วย target name <code class="docutils literal"><span class="pre">t1</span></code> (เป็นชื่ออะไรก็ได้)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/&gt;</span><span class="n">iscsi</span><span class="o">/</span> <span class="n">create</span> <span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span>
<span class="n">Created</span> <span class="n">target</span> <span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">.</span>
<span class="n">Created</span> <span class="n">TPG</span> <span class="mf">1.</span>
<span class="n">Global</span> <span class="n">pref</span> <span class="n">auto_add_default_portal</span><span class="o">=</span><span class="n">true</span>
<span class="n">Created</span> <span class="n">default</span> <span class="n">portal</span> <span class="n">listening</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">IPs</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">port</span> <span class="mf">3260.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">IQN อ้างอิงตามมาตรฐาน RFC 3270 ( <a class="reference external" href="http://en.wikipedia.org/wiki/ISCSI">http://en.wikipedia.org/wiki/ISCSI</a>)</p>
</div>
<p>จะได้ folder ใหม่ ตามชื่อ target ที่สร้างขึ้น และภายในfolder ก็จะมี folder ย่อย</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/&gt;</span> <span class="n">cd</span> <span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">/</span>
<span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">le</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">&gt;</span> <span class="n">ls</span>
</pre></div>
</div>
<img alt="_images/iscsi003.png" src="_images/iscsi003.png" />
<p>ภายใต้ tpg1 มี object ทั้งหมด  3 ตัวด้วยกัน</p>
<blockquote>
<div><ul class="simple">
<li>acls (access control lists: restrict access to resources),</li>
<li>luns (logical unit number: define exported resources),</li>
<li>portals (define ways to reach the exported resources; consist in pairs of IP addresses and ports).</li>
</ul>
</div></blockquote>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">le</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">&gt;</span> <span class="n">tpg1</span><span class="o">/</span><span class="n">luns</span> <span class="n">create</span> <span class="o">/</span><span class="n">backstores</span><span class="o">/</span><span class="n">fileio</span><span class="o">/</span><span class="n">sharedata</span>
</pre></div>
</div>
<p>/iscsi/iqn.20...le.server1:t1&gt; tpg1/luns create /backstores/block/server1.disk1
Created LUN 1.</p>
<img alt="_images/iscsi004.png" src="_images/iscsi004.png" />
<ul class="simple">
<li>step3 สร้าง acl อ้างอิงกับ iqn ที่สร้างขึ้น <code class="docutils literal"><span class="pre">iqn.2016-07.com.example.server1</span></code></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">le</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">&gt;</span> <span class="n">tpg1</span><span class="o">/</span><span class="n">acls</span> <span class="n">create</span> <span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">client</span>
    <span class="n">Created</span> <span class="n">Node</span> <span class="n">ACL</span> <span class="k">for</span> <span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">client</span>
    <span class="n">Created</span> <span class="n">mapped</span> <span class="n">LUN</span> <span class="mf">1.</span>
    <span class="n">Created</span> <span class="n">mapped</span> <span class="n">LUN</span> <span class="mf">0.</span>
<span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">le</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">t1</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">tpg1</span><span class="o">/</span><span class="n">acls</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">client</span><span class="o">/</span>

    <span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">erver1</span><span class="p">:</span><span class="n">client</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">auth</span> <span class="n">userid</span><span class="o">=</span><span class="n">usr</span>
    <span class="n">Parameter</span> <span class="n">userid</span> <span class="ow">is</span> <span class="n">now</span> <span class="s1">&#39;usr&#39;</span><span class="o">.</span>
    <span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">erver1</span><span class="p">:</span><span class="n">client</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">auth</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span>
    <span class="n">Parameter</span> <span class="n">password</span> <span class="ow">is</span> <span class="n">now</span> <span class="s1">&#39;pwd&#39;</span><span class="o">.</span>

<span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">erver1</span><span class="p">:</span><span class="n">client</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="o">../..</span>
<span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">rver1</span><span class="p">:</span><span class="n">t1</span><span class="o">/</span><span class="n">tpg1</span><span class="o">&gt;</span> <span class="n">ls</span>
</pre></div>
</div>
<img alt="_images/iscsi005.png" src="_images/iscsi005.png" />
<ul class="simple">
<li>step4 สุดท้ายให้ออกจาก prompt ด้วยการพิม exit</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">iqn</span><span class="o">.</span><span class="mf">20.</span><span class="o">..</span><span class="n">rver1</span><span class="p">:</span><span class="n">t1</span><span class="o">/</span><span class="n">tpg1</span><span class="o">&gt;</span> <span class="n">exit</span>
<span class="n">Global</span> <span class="n">pref</span> <span class="n">auto_save_on_exit</span><span class="o">=</span><span class="n">true</span>
<span class="n">Last</span> <span class="mi">10</span> <span class="n">configs</span> <span class="n">saved</span> <span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">backup</span><span class="o">.</span>
<span class="n">Configuration</span> <span class="n">saved</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">saveconfig</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>จะได้ config ไฟล์เก็บไว้ที่  /etc/target/saveconfig.json</p>
<img alt="_images/iscsi006.png" src="_images/iscsi006.png" />
<ul class="simple">
<li>step 5 verify</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">net</span><span class="o">-</span><span class="n">tools</span>

    <span class="c1"># netstat -ant | grep 3260</span>
    <span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">3260</span>            <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="o">*</span>               <span class="n">LISTEN</span>

<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">3260</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="install-iscsi-client">
<h3>Install ISCSI Client<a class="headerlink" href="#install-iscsi-client" title="Permalink to this headline">¶</a></h3>
<p>เครื่อง client จะเรียกว่า initiator (เครื่อง server เรียกว่า target)
install
&#8212;&#8212;-</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">ssh</span> <span class="n">server2</span>
<span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span>
<span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">iscsi</span><span class="o">-</span><span class="n">initiator</span><span class="o">-</span><span class="n">utils</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iscsi</span><span class="o">/</span>
<span class="n">ls</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iscsi</span><span class="o">/</span><span class="n">initiatorname</span><span class="o">.</span><span class="n">iscsi</span>

<span class="n">InitiatorName</span><span class="o">=</span><span class="n">iqn</span><span class="o">.</span><span class="mi">2016</span><span class="o">-</span><span class="mf">07.</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">server1</span><span class="p">:</span><span class="n">client</span>

<span class="n">vi</span> <span class="n">iscsid</span><span class="o">.</span><span class="n">conf</span>
<span class="mi">57</span> <span class="n">node</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authmethod</span> <span class="o">=</span> <span class="n">CHAP</span>
<span class="mi">61</span> <span class="n">node</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">usr</span>
<span class="mi">62</span> <span class="n">node</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">pwd</span>
</pre></div>
</div>
<p>start service</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>systemctl start iscsi
systemctl enable iscsi
(server1 eth0ip = 192.168.121.144)
iscsiadm --mode discovery --type sendtargets --portal 192.168.121.144
192.168.121.144:3260,1 iqn.2016-07.com.example.server1:t1
(นำค่าที่ได้ target name ที่ได้ ``iqn.2016-07.com.example.server1:t1`` มา ใช้)

iscsiadm --mode node --targetname iqn.2016-07.com.example.server1:t1 --portal 192.168.121.144 --login

(result)
Logging in to [iface: default, target: iqn.2016-07.com.example.server1:t1, portal: 192.168.121.144,3260] (multiple)
Login to [iface: default, target: iqn.2016-07.com.example.server1:t1, portal: 192.168.121.144,3260] successful.
</pre></div>
</div>
<div class="section" id="verify">
<h4>verify<a class="headerlink" href="#verify" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">lsblk</span> <span class="o">--</span><span class="n">scsi</span>
<span class="n">NAME</span> <span class="n">HCTL</span>       <span class="n">TYPE</span> <span class="n">VENDOR</span>   <span class="n">MODEL</span>             <span class="n">REV</span> <span class="n">TRAN</span>
<span class="n">sda</span>  <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span>    <span class="n">disk</span> <span class="n">LIO</span><span class="o">-</span><span class="n">ORG</span>  <span class="n">sharedata</span>        <span class="mf">4.0</span>  <span class="n">iscsi</span>
<span class="n">sdb</span>  <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span>    <span class="n">disk</span> <span class="n">LIO</span><span class="o">-</span><span class="n">ORG</span>  <span class="n">server1</span><span class="o">.</span><span class="n">disk1</span>    <span class="mf">4.0</span>  <span class="n">iscsi</span>
</pre></div>
</div>
</div>
<div class="section" id="use-disk">
<h4>use disk<a class="headerlink" href="#use-disk" title="Permalink to this headline">¶</a></h4>
<p>การใช้งาน  disk</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>

<span class="n">blkid</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">&quot;/dev/sda&quot;</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="n">UUID</span><span class="o">=</span><span class="s2">&quot;e45f36b4-f65b-4e8b-85df-be51024193fe&quot;</span> <span class="n">TYPE</span><span class="o">=</span><span class="s2">&quot;ext4&quot;</span>

<span class="n">mkdir</span> <span class="o">/</span><span class="n">iscsi_sda</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="p">(</span><span class="n">เพิ่ม</span> <span class="n">ต่อสุดท้าย</span><span class="p">)</span>
<span class="n">UUID</span><span class="o">=</span><span class="n">e45f36b4</span><span class="o">-</span><span class="n">f65b</span><span class="o">-</span><span class="mi">4</span><span class="n">e8b</span><span class="o">-</span><span class="mi">85</span><span class="n">df</span><span class="o">-</span><span class="n">be51024193fe</span> <span class="o">/</span><span class="n">iscsi_sda</span>  <span class="n">ext4</span> <span class="n">_netdev</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="n">mount</span> <span class="o">-</span><span class="n">a</span>
<span class="n">mount</span>
<span class="p">(</span><span class="n">ในบรรทัดสุดท้ายแสดงผลการ</span> <span class="n">mount</span><span class="p">)</span>

<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span> <span class="n">on</span> <span class="o">/</span><span class="n">iscsi_sda</span> <span class="nb">type</span> <span class="n">ext4</span> <span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">seclabel</span><span class="p">,</span><span class="n">stripe</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">ordered</span><span class="p">,</span><span class="n">_netdev</span><span class="p">)</span>
</pre></div>
</div>
<p>ทำขั้นตอนอีกครัั้งสำหรับ /dev/sdb</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span>
<span class="n">blkid</span> <span class="o">|</span> <span class="n">grep</span> <span class="s2">&quot;/dev/sdb&quot;</span>

<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span><span class="p">:</span> <span class="n">UUID</span><span class="o">=</span><span class="s2">&quot;24fd379c-7045-4670-9574-1c797def1cda&quot;</span> <span class="n">TYPE</span><span class="o">=</span><span class="s2">&quot;ext4&quot;</span>

<span class="n">mkdir</span> <span class="o">/</span><span class="n">iscsi_sdb</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>

<span class="n">UUID</span><span class="o">=</span><span class="mi">24</span><span class="n">fd379c</span><span class="o">-</span><span class="mi">7045</span><span class="o">-</span><span class="mi">4670</span><span class="o">-</span><span class="mi">9574</span><span class="o">-</span><span class="mi">1</span><span class="n">c797def1cda</span> <span class="o">/</span><span class="n">iscsi_sdb</span>  <span class="n">ext4</span> <span class="n">_netdev</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="n">mount</span> <span class="o">-</span><span class="n">a</span>
<span class="n">mount</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="virtualdev.html" class="btn btn-neutral float-right" title="Network Virtualization Device" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lvm.html" class="btn btn-neutral" title="Linux LVM partition" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, sawangpong muadphet &lt;sawangpong@itbakery.net&gt;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'latest',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>